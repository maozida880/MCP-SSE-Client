# 12306-MCP å®¢æˆ·ç«¯ V2.0 æŠ€æœ¯æ¶æ„æ–‡æ¡£

## ğŸ“ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ç”¨æˆ·äº¤äº’å±‚                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚ Chat Loop  â”‚  â”‚  Commands  â”‚  â”‚   CLI UI     â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ ¸å¿ƒå®¢æˆ·ç«¯å±‚ (V2.0)                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚         Train12306MCPClient                          â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚Config Mgr  â”‚  â”‚Profile Mgr â”‚  â”‚ Memory Mgr   â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â–¼                   â–¼                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM Service  â”‚   â”‚ MCP Server   â”‚   â”‚ Local Files  â”‚
â”‚ (DeepSeek)   â”‚   â”‚ (12306-mcp)  â”‚   â”‚ (JSON/Log)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. ConfigManagerï¼ˆé…ç½®ç®¡ç†å™¨ï¼‰

**èŒè´£**ï¼šç»Ÿä¸€ç®¡ç†æ‰€æœ‰é…ç½®é¡¹ï¼Œæ”¯æŒ JSON é…ç½®æ–‡ä»¶å’Œé»˜è®¤é…ç½®ã€‚

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `_load_config()`: åŠ è½½é…ç½®æ–‡ä»¶
- `get(path, default)`: é€šè¿‡ç‚¹åˆ†è·¯å¾„è·å–é…ç½®é¡¹

**è®¾è®¡äº®ç‚¹**ï¼š
- æ”¯æŒåµŒå¥—é…ç½®ï¼ˆå¦‚ `mcp_server.connection.retry_attempts`ï¼‰
- é…ç½®ç¼ºå¤±æ—¶ä½¿ç”¨åˆç†é»˜è®¤å€¼
- ç¯å¢ƒå˜é‡ä¼˜å…ˆçº§é«˜äºé…ç½®æ–‡ä»¶

**ç¤ºä¾‹**ï¼š
```python
config = ConfigManager("config.json")
retry_attempts = config.get('mcp_server.connection.retry_attempts', 3)
```

---

### 2. UserProfileManagerï¼ˆç”¨æˆ·é…ç½®ç®¡ç†å™¨ï¼‰

**èŒè´£**ï¼šç®¡ç†ç”¨æˆ·åå¥½ã€åœ°ç‚¹åˆ«åå’Œå†å²ç»Ÿè®¡ã€‚

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `get_user_context()`: ç”Ÿæˆç”¨æˆ·ä¸Šä¸‹æ–‡å­—ç¬¦ä¸²ï¼Œæ³¨å…¥åˆ°ç³»ç»Ÿæç¤º
- `update_query_stats()`: æ›´æ–°æŸ¥è¯¢ç»Ÿè®¡
- `save()`: æŒä¹…åŒ–ç”¨æˆ·é…ç½®

**æ•°æ®æ¨¡å‹**ï¼š
```json
{
  "user_id": "string",
  "preferences": {
    "default_departure_city": "string",
    "preferred_seat_type": "string"
  },
  "aliases": {
    "home": "æ·±åœ³åŒ—",
    "office": "åŒ—äº¬å—"
  },
  "metadata": {
    "total_queries": 0,
    "last_active": "ISO8601"
  }
}
```

**è®¾è®¡äº®ç‚¹**ï¼š
- ç”¨æˆ·åå¥½è‡ªåŠ¨æ³¨å…¥åˆ° LLM ç³»ç»Ÿæç¤º
- æ”¯æŒåœ°ç‚¹åˆ«åï¼Œæå‡ç”¨æˆ·ä½“éªŒ
- ç»Ÿè®¡ä¿¡æ¯ç”¨äºæœªæ¥çš„ä¸ªæ€§åŒ–æ¨è

---

### 3. ConversationMemoryï¼ˆä¼šè¯è®°å¿†ç®¡ç†å™¨ï¼‰

**èŒè´£**ï¼šç®¡ç†å½“å‰ä¼šè¯å’Œå†å²å¯¹è¯è®°å½•ã€‚

**æ ¸å¿ƒæ–¹æ³•**ï¼š
- `add_message(role, content)`: æ·»åŠ æ¶ˆæ¯åˆ°å½“å‰ä¼šè¯
- `get_current_session()`: è·å–å½“å‰ä¼šè¯ï¼ˆç”¨äº LLMï¼‰
- `clear_session()`: æ¸…ç©ºä¼šè¯å¹¶ä¿å­˜åˆ°å†å²
- `get_recent_context()`: è·å–æœ€è¿‘å¯¹è¯çš„æ‘˜è¦

**æ•°æ®æ¨¡å‹**ï¼š
```python
current_session = [
    {"role": "user", "content": "...", "timestamp": "ISO8601"},
    {"role": "assistant", "content": "...", "timestamp": "ISO8601"},
]

history = [
    {
        "session_id": "ISO8601",
        "messages": [...]
    }
]
```

**è®¾è®¡äº®ç‚¹**ï¼š
- æ™ºèƒ½æˆªæ–­ï¼šä¿ç•™æœ€æ–°çš„ N æ¡æ¶ˆæ¯ï¼Œé¿å…ä¸Šä¸‹æ–‡è¶…é™
- å†å²åŠ è½½ï¼šå¯é€‰åŠ è½½æœ€è¿‘å‡ æ¬¡ä¼šè¯çš„æ‘˜è¦
- æ—¶é—´æˆ³è®°å½•ï¼šä¾¿äºæœªæ¥åˆ†æå¯¹è¯æ¨¡å¼

---

### 4. Train12306MCPClientï¼ˆä¸»å®¢æˆ·ç«¯ï¼‰

**èŒè´£**ï¼šåè°ƒæ‰€æœ‰æ¨¡å—ï¼Œç®¡ç†ä¸ MCP æœåŠ¡å™¨å’Œ LLM çš„äº¤äº’ã€‚

#### 4.1 å¢å¼ºçš„è¿æ¥ç®¡ç†

##### è‡ªåŠ¨é‡è¿æœºåˆ¶

**å®ç°**ï¼šæŒ‡æ•°é€€é¿ç®—æ³•

```python
async def _make_mcp_request(self, method, params):
    for attempt in range(retry_attempts):
        try:
            # å‘é€è¯·æ±‚
            ...
        except NetworkError:
            wait_time = retry_delay * (2 ** attempt)
            await asyncio.sleep(wait_time)
```

**é€€é¿ç­–ç•¥**ï¼š
- ç¬¬1æ¬¡é‡è¯•ï¼šç­‰å¾… 1 ç§’
- ç¬¬2æ¬¡é‡è¯•ï¼šç­‰å¾… 2 ç§’
- ç¬¬3æ¬¡é‡è¯•ï¼šç­‰å¾… 4 ç§’
- ...ï¼ˆæœ€å¤§ä¸è¶…è¿‡ `max_retry_delay`ï¼‰

##### SSE è‡ªåŠ¨é‡è¿

**å®ç°**ï¼š
```python
async def _listen_sse_with_reconnect(self):
    while self.is_connected:
        try:
            # è¿æ¥ SSE
            ...
        except Exception:
            await asyncio.sleep(reconnect_interval)
```

**ç‰¹ç‚¹**ï¼š
- è¿æ¥æ–­å¼€åè‡ªåŠ¨é‡è¿
- å¯é…ç½®é‡è¿é—´éš”
- æ”¯æŒä¼˜é›…å…³é—­ï¼ˆ`is_connected` æ ‡å¿—ï¼‰

##### å¿ƒè·³ä¿æŒ

**å®ç°**ï¼š
```python
async def _heartbeat_loop(self, interval):
    while self.is_connected:
        await asyncio.sleep(interval)
        await self._make_mcp_request("ping", {})
```

**ä½œç”¨**ï¼š
- å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
- é˜²æ­¢é•¿è¿æ¥è¶…æ—¶
- åŠæ—©å‘ç°ç½‘ç»œé—®é¢˜

#### 4.2 æ™ºèƒ½å¼‚å¸¸å¤„ç†

**é”™è¯¯åˆ†ç±»**ï¼š

| é”™è¯¯ç±»å‹ | å¤„ç†ç­–ç•¥ | ç¤ºä¾‹ |
|---------|----------|------|
| ç¬æ—¶æ•…éšœ | è‡ªåŠ¨é‡è¯• | ç½‘ç»œè¶…æ—¶ã€æœåŠ¡å™¨ 503 |
| æ°¸ä¹…é”™è¯¯ | è¿”å›é”™è¯¯ä¿¡æ¯ç»™ LLM | å‚æ•°é”™è¯¯ 400ã€è®¤è¯å¤±è´¥ 401 |
| ç³»ç»Ÿé”™è¯¯ | è®°å½•æ—¥å¿—å¹¶é€€å‡º | é…ç½®é”™è¯¯ã€ä¾èµ–ç¼ºå¤± |

**é‡è¯•å†³ç­–æ ‘**ï¼š
```
é”™è¯¯å‘ç”Ÿ
    â”‚
    â”œâ”€ ç½‘ç»œé”™è¯¯ï¼Ÿ
    â”‚   â””â”€ æ˜¯ â†’ é‡è¯•ï¼ˆæœ€å¤š N æ¬¡ï¼‰
    â”‚
    â”œâ”€ HTTP 5xxï¼Ÿ
    â”‚   â””â”€ æ˜¯ â†’ é‡è¯•ï¼ˆæœ€å¤š N æ¬¡ï¼‰
    â”‚
    â””â”€ å…¶ä»–é”™è¯¯ï¼Ÿ
        â””â”€ è¿”å›é”™è¯¯ä¿¡æ¯
```

#### 4.3 ä¼šè¯è®°å¿†é›†æˆ

**ç³»ç»Ÿæç¤ºæ„å»º**ï¼š
```python
def _build_system_prompt(self):
    base_prompt = "..."  # åŸºç¡€æç¤º
    
    # æ³¨å…¥ç”¨æˆ·åå¥½
    if self.profile:
        base_prompt += self.profile.get_user_context()
    
    # æ³¨å…¥å†å²æ‘˜è¦
    if self.memory:
        base_prompt += self.memory.get_recent_context()
    
    return base_prompt
```

**å¯¹è¯æµç¨‹**ï¼š
```
ç”¨æˆ·è¾“å…¥ â†’ è®°å½•åˆ° memory â†’ æ„å»º messages â†’ è°ƒç”¨ LLM
                                              â†“
åŠ©æ‰‹å›å¤ â† è®°å½•åˆ° memory â† è§£æå“åº” â† æ¥æ”¶å“åº”
```

---

## ğŸ”„ å…³é”®æµç¨‹

### 1. å¯åŠ¨æµç¨‹

```
main()
  â”‚
  â”œâ”€ åŠ è½½é…ç½® (ConfigManager)
  â”œâ”€ åˆå§‹åŒ–æ—¥å¿—
  â”œâ”€ åŠ è½½ç”¨æˆ·é…ç½® (UserProfileManager)
  â”œâ”€ åˆå§‹åŒ–è®°å¿† (ConversationMemory)
  â”‚
  â”œâ”€ connect()
  â”‚   â”œâ”€ åˆ›å»º HTTP Session
  â”‚   â”œâ”€ å¯åŠ¨ SSE ç›‘å¬ä»»åŠ¡
  â”‚   â”œâ”€ å¯åŠ¨å¿ƒè·³ä»»åŠ¡
  â”‚   â”œâ”€ åˆå§‹åŒ– MCP è¿æ¥
  â”‚   â””â”€ è·å–å·¥å…·åˆ—è¡¨
  â”‚
  â””â”€ chat_loop()
      â””â”€ è¿›å…¥äº¤äº’å¾ªç¯
```

### 2. å¯¹è¯æµç¨‹ï¼ˆå¸¦è®°å¿†ï¼‰

```
ç”¨æˆ·è¾“å…¥: "æ˜å¤©æ·±åœ³åˆ°å¹¿å·çš„é«˜é“ç¥¨"
  â”‚
  â”œâ”€ memory.add_message("user", ...)
  â”œâ”€ æ„å»º system_prompt (å«ç”¨æˆ·åå¥½å’Œå†å²)
  â”œâ”€ messages = [system, *history, user_message]
  â”‚
  â”œâ”€ LLM æ€è€ƒ
  â”‚   â”œâ”€ å†³å®šè°ƒç”¨ get-current-date
  â”‚   â”œâ”€ å†³å®šè°ƒç”¨ get-station-code-of-citys
  â”‚   â””â”€ å†³å®šè°ƒç”¨ get-tickets
  â”‚
  â”œâ”€ æ‰§è¡Œå·¥å…·è°ƒç”¨ï¼ˆè‡ªåŠ¨é‡è¯•ï¼‰
  â”‚
  â”œâ”€ LLM ç”Ÿæˆå›å¤
  â””â”€ memory.add_message("assistant", ...)

ç”¨æˆ·ç»§ç»­è¾“å…¥: "æœ€æ—©çš„é‚£è¶Ÿæœ‰äºŒç­‰åº§å—ï¼Ÿ"
  â”‚
  â”œâ”€ memory.add_message("user", ...)
  â”œâ”€ messages åŒ…å«ä¸Šä¸€è½®çš„å®Œæ•´å¯¹è¯
  â”‚
  â””â”€ LLM ç›´æ¥æ ¹æ®ä¸Šä¸‹æ–‡å›ç­”ï¼ˆæ— éœ€é‡æ–°æŸ¥è¯¢ï¼‰
```

### 3. é”™è¯¯æ¢å¤æµç¨‹

```
å·¥å…·è°ƒç”¨å¤±è´¥
  â”‚
  â”œâ”€ æ˜¯ç½‘ç»œé”™è¯¯ï¼Ÿ
  â”‚   â”œâ”€ æ˜¯ â†’ ç­‰å¾… 1 ç§’ï¼Œé‡è¯•
  â”‚   â”œâ”€ ä»å¤±è´¥ â†’ ç­‰å¾… 2 ç§’ï¼Œé‡è¯•
  â”‚   â””â”€ ä»å¤±è´¥ â†’ ç­‰å¾… 4 ç§’ï¼Œé‡è¯•
  â”‚
  â”œâ”€ æ˜¯æœåŠ¡å™¨é”™è¯¯ (5xx)ï¼Ÿ
  â”‚   â””â”€ åŒä¸Šï¼Œè‡ªåŠ¨é‡è¯•
  â”‚
  â””â”€ æ˜¯å‚æ•°é”™è¯¯ (4xx)ï¼Ÿ
      â””â”€ è¿”å›é”™è¯¯ä¿¡æ¯ç»™ LLMï¼Œè®©å…¶ä¿®æ­£
```

---

## ğŸ§© æ•°æ®æµ

### é…ç½®åŠ è½½

```
å¯åŠ¨
  â†“
å°è¯•è¯»å– config.json
  â”œâ”€ æˆåŠŸ â†’ ä½¿ç”¨é…ç½®
  â””â”€ å¤±è´¥ â†’ ä½¿ç”¨é»˜è®¤é…ç½®
  â†“
è¯»å– .env æ–‡ä»¶
  â”œâ”€ API Key â†’ ç¯å¢ƒå˜é‡
  â””â”€ å…¶ä»–é…ç½® â†’ å¯è¢« config.json è¦†ç›–
  â†“
æœ€ç»ˆé…ç½® = ç¯å¢ƒå˜é‡ > config.json > é»˜è®¤å€¼
```

### ç”¨æˆ·ä¸Šä¸‹æ–‡ä¼ é€’

```
UserProfileManager
  â†“
get_user_context()
  â†“
"# ç”¨æˆ·åå¥½\n- å¸¸ç”¨å‡ºå‘åœ°: æ·±åœ³\n..."
  â†“
_build_system_prompt()
  â†“
System Prompt â†’ LLM
  â†“
LLM è‡ªåŠ¨åˆ©ç”¨ç”¨æˆ·åå¥½
```

### ä¼šè¯è®°å¿†ä¼ é€’

```
messages = [
  {"role": "system", "content": "..."},
  {"role": "user", "content": "æ˜å¤©..."},
  {"role": "assistant", "content": "..."},
  {"role": "user", "content": "æœ€æ—©çš„é‚£è¶Ÿ..."}  â† å½“å‰è¾“å…¥
]
  â†“
LLM çœ‹åˆ°å®Œæ•´ä¸Šä¸‹æ–‡
  â†“
ç†è§£"æœ€æ—©çš„é‚£è¶Ÿ"æŒ‡çš„æ˜¯ä¸Šä¸€è½®çš„æŸ¥è¯¢ç»“æœ
```

---

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–

### 1. å†…å­˜ç®¡ç†

**é—®é¢˜**ï¼šå¯¹è¯å†å²æ— é™å¢é•¿ä¼šå¯¼è‡´ Token è¶…é™ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ™ºèƒ½æˆªæ–­ï¼šä¿ç•™æœ€æ–°çš„ N æ¡æ¶ˆæ¯
- å†å²ä¿å­˜ï¼šæ—§æ¶ˆæ¯ä¿å­˜åˆ°æ–‡ä»¶
- æŒ‰éœ€åŠ è½½ï¼šåªåœ¨å¿…è¦æ—¶åŠ è½½å†å²æ‘˜è¦

**å®ç°**ï¼š
```python
def get_current_session(self):
    # åªè¿”å›æœ€æ–°çš„ max_context_messages æ¡
    messages = self.current_session[-self.max_context_messages:]
    return messages
```

### 2. ç½‘ç»œä¼˜åŒ–

**é—®é¢˜**ï¼šé¢‘ç¹çš„ç½‘ç»œè¯·æ±‚å¯¼è‡´å»¶è¿Ÿã€‚

**ä¼˜åŒ–**ï¼š
- å·¥å…·åˆ—è¡¨ç¼“å­˜ï¼šåªåœ¨å¯åŠ¨æ—¶è·å–ä¸€æ¬¡
- æ‰¹é‡æ“ä½œï¼šæœªæ¥å¯è€ƒè™‘æ‰¹é‡å·¥å…·è°ƒç”¨
- é•¿è¿æ¥ï¼šä½¿ç”¨ HTTP/1.1 Keep-Alive

### 3. å¹¶å‘æ§åˆ¶

**å½“å‰**ï¼šå•çº¿ç¨‹å¼‚æ­¥ I/Oï¼ˆ`asyncio`ï¼‰

**ä¼˜åŠ¿**ï¼š
- é«˜æ•ˆå¤„ç† I/O å¯†é›†å‹ä»»åŠ¡
- ä½å†…å­˜å ç”¨
- ç®€å•çš„é”™è¯¯å¤„ç†

**æœªæ¥**ï¼š
- æ”¯æŒå¤šç”¨æˆ·ï¼šä½¿ç”¨è¿›ç¨‹æ± æˆ–å¤šå®ä¾‹
- å·¥å…·å¹¶è¡Œè°ƒç”¨ï¼šæŸäº›ç‹¬ç«‹å·¥å…·å¯å¹¶è¡Œæ‰§è¡Œ

---

## ğŸ” å®‰å…¨è®¾è®¡

### 1. å‡­è¯ç®¡ç†

**åŸåˆ™**ï¼šæ•æ„Ÿä¿¡æ¯ä¸å­˜å‚¨åœ¨é…ç½®æ–‡ä»¶ä¸­ã€‚

**å®ç°**ï¼š
- API Key åªå­˜å‚¨åœ¨ `.env` æ–‡ä»¶
- `.env` æ–‡ä»¶åŠ å…¥ `.gitignore`
- æ—¥å¿—ä¸­ä¸è¾“å‡º API Key

### 2. é”™è¯¯ä¿¡æ¯

**åŸåˆ™**ï¼šä¸å‘ç”¨æˆ·æš´éœ²ç³»ç»Ÿå†…éƒ¨ç»†èŠ‚ã€‚

**å®ç°**ï¼š
- æ•è·æ‰€æœ‰å¼‚å¸¸
- å‘ç”¨æˆ·æ˜¾ç¤ºå‹å¥½çš„é”™è¯¯ä¿¡æ¯
- è¯¦ç»†é”™è¯¯è®°å½•åˆ°æ—¥å¿—æ–‡ä»¶

### 3. è¾“å…¥éªŒè¯

**å·¥å…·è°ƒç”¨å‚æ•°**ï¼š
- LLM ç”Ÿæˆå‚æ•° â†’ JSON æ ¡éªŒ
- æ ¼å¼é”™è¯¯ â†’ è¿”å›é”™è¯¯ä¿¡æ¯ç»™ LLM
- LLM è‡ªæˆ‘ä¿®æ­£

---

## ğŸ“Š å¯è§‚æµ‹æ€§

### 1. æ—¥å¿—ç³»ç»Ÿ

**åˆ†çº§**ï¼š
- `DEBUG`ï¼šè¯¦ç»†çš„è°ƒè¯•ä¿¡æ¯ï¼ˆå·¥å…·å‚æ•°ã€å“åº”ï¼‰
- `INFO`ï¼šæ­£å¸¸æ“ä½œæµç¨‹
- `WARNING`ï¼šè­¦å‘Šï¼ˆé‡è¯•ã€é…ç½®ç¼ºå¤±ï¼‰
- `ERROR`ï¼šé”™è¯¯ï¼ˆè¿æ¥å¤±è´¥ã€å·¥å…·è°ƒç”¨å¤±è´¥ï¼‰

**è¾“å‡º**ï¼š
- æ§åˆ¶å°ï¼šå®æ—¶æŸ¥çœ‹
- æ–‡ä»¶ï¼šæŒä¹…åŒ–å­˜å‚¨

### 2. æ€§èƒ½ç›‘æ§

**æœªæ¥å¢å¼º**ï¼š
- å·¥å…·è°ƒç”¨è€—æ—¶ç»Ÿè®¡
- æˆåŠŸç‡ç›‘æ§
- Token ä½¿ç”¨é‡ç»Ÿè®¡

---

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•ï¼ˆæœªæ¥ï¼‰

```python
# test_config_manager.py
def test_config_loading():
    config = ConfigManager("test_config.json")
    assert config.get("mcp_server.url") == "http://test:12306"

# test_memory.py
def test_session_memory():
    memory = ConversationMemory(max_messages=5)
    memory.add_message("user", "test")
    assert len(memory.current_session) == 1
```

### é›†æˆæµ‹è¯•

ä½¿ç”¨ `test_v2_features.py`ï¼š
- æ–‡ä»¶ç»“æ„æ£€æŸ¥
- é…ç½®éªŒè¯
- ä¾èµ–æ£€æŸ¥
- è¯­æ³•æ£€æŸ¥

### ç«¯åˆ°ç«¯æµ‹è¯•

æ‰‹åŠ¨æµ‹è¯•å…³é”®åœºæ™¯ï¼š
1. åŸºç¡€æŸ¥è¯¢
2. è¿ç»­å¯¹è¯
3. æ–­çº¿é‡è¿
4. å·¥å…·è°ƒç”¨å¤±è´¥

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### æœ¬åœ°éƒ¨ç½²

```bash
# 1. å…‹éš†é¡¹ç›®
git clone ...

# 2. å®‰è£…ä¾èµ–
pip install -r requirements.txt

# 3. é…ç½®ç¯å¢ƒ
cp .env.example .env
# ç¼–è¾‘ .env å¡«å†™ API Key

# 4. å¯åŠ¨æœåŠ¡å™¨
npx -y 12306-mcp --port 12306

# 5. è¿è¡Œå®¢æˆ·ç«¯
python MCP-SEE-Client-V2.py
```

### ç”Ÿäº§éƒ¨ç½²ï¼ˆæœªæ¥ï¼‰

```bash
# ä½¿ç”¨ systemd æœåŠ¡
sudo systemctl start mcp-client

# ä½¿ç”¨ Docker
docker-compose up -d

# ä½¿ç”¨ supervisor
supervisorctl start mcp-client
```

---

## ğŸ“– API æ–‡æ¡£ï¼ˆå†…éƒ¨ï¼‰

### ConfigManager

```python
class ConfigManager:
    def __init__(self, config_path: str)
    def get(self, path: str, default: Any = None) -> Any
```

### UserProfileManager

```python
class UserProfileManager:
    def __init__(self, profile_path: str)
    def get_user_context(self) -> str
    def update_query_stats(self)
    def save(self)
```

### ConversationMemory

```python
class ConversationMemory:
    def __init__(self, history_path: str, max_messages: int)
    def add_message(self, role: str, content: str)
    def get_current_session(self) -> List[Dict]
    def clear_session(self)
    def get_recent_context(self, count: int) -> str
```

### Train12306MCPClient

```python
class Train12306MCPClient:
    def __init__(self, config_path: str)
    async def connect(self)
    async def chat(self, user_message: str) -> str
    async def call_tool(self, name: str, args: Dict) -> Any
    async def cleanup(self)
```

---

## ğŸ”® æ‰©å±•æ€§è®¾è®¡

### æ’ä»¶ç³»ç»Ÿï¼ˆV3.0ï¼‰

æœªæ¥å¯æ”¯æŒè‡ªå®šä¹‰å·¥å…·ï¼š

```python
class CustomTool:
    def __init__(self):
        self.name = "my-tool"
        self.description = "..."
    
    async def execute(self, args: Dict) -> Any:
        # è‡ªå®šä¹‰é€»è¾‘
        pass

# æ³¨å†Œå·¥å…·
client.register_tool(CustomTool())
```

### å¤š LLM æ”¯æŒ

é€šè¿‡é€‚é…å™¨æ¨¡å¼æ”¯æŒå¤šç§ LLMï¼š

```python
class LLMAdapter:
    async def chat(self, messages, tools): ...

class DeepSeekAdapter(LLMAdapter): ...
class OpenAIAdapter(LLMAdapter): ...
class OllamaAdapter(LLMAdapter): ...
```

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [MCP åè®®è§„èŒƒ](https://modelcontextprotocol.io/)
- [12306-mcp æœåŠ¡ç«¯](https://github.com/Joooook/12306-mcp)
- [aiohttp æ–‡æ¡£](https://docs.aiohttp.org/)
- [OpenAI API æ–‡æ¡£](https://platform.openai.com/docs/)

---

**æ–‡æ¡£ç‰ˆæœ¬**: V2.0.0  
**æ›´æ–°æ—¥æœŸ**: 2025-10-22  
**ç»´æŠ¤è€…**: ç®—æ³•å·¥ç¨‹å›¢é˜Ÿ
